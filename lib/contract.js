var web3 = require('./web3.js');
var connection = require('./SQL.js');

var annuityContract = web3.eth.contract([{"constant":true,"inputs":[],"name":"getVersion","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getPayTime","outputs":[{"name":"","type":"uint256[3]"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getCompanyAddress","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getStatus","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"version","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"destroy","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"year","type":"uint256"},{"name":"month","type":"uint256"},{"name":"day","type":"uint256"}],"name":"confirme","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"endAnnuity","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getNowTime","outputs":[{"name":"","type":"uint256[3]"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getDeployTime","outputs":[{"name":"","type":"uint256[3]"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getInsurerAddress","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"revoke","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getRevocationPeriod","outputs":[{"name":"","type":"uint256[3]"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"year","type":"uint256"},{"name":"month","type":"uint256"},{"name":"day","type":"uint256"}],"name":"time","outputs":[],"payable":false,"type":"function"},{"inputs":[{"name":"y","type":"uint256"},{"name":"m","type":"uint256"},{"name":"d","type":"uint256"}],"payable":false,"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"from","type":"address"},{"indexed":false,"name":"inf","type":"string"},{"indexed":false,"name":"timestamp","type":"uint256"}],"name":"confirmeEvent","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"from","type":"address"},{"indexed":false,"name":"inf","type":"string"},{"indexed":false,"name":"timestamp","type":"uint256"}],"name":"revokeEvent","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"from","type":"address"},{"indexed":false,"name":"inf","type":"string"},{"indexed":false,"name":"timestamp","type":"uint256"}],"name":"payEvent","type":"event"}]);
class Contract {
    constructor() {
        
    }
    deploy(ID) {
        this.annuity = annuityContract.new(
            new Date().getFullYear(), new Date().getMonth()+1, new Date().getDate(),
            {
                from: web3.eth.accounts[0],
                data: '6060604052604060405190810160405280600581526020017f312e302e340000000000000000000000000000000000000000000000000000008152506010908051906020019062000052929190620003c4565b5034156200005c57fe5b604051606080620014a4833981016040528080519060200190919080519060200190919080519060200190919050505b33600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555073e2320c12c71fb4a91d756d21507b33ee05f2f4c7600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506103e860038190555060016017819055506000601181905550606060405190810160405280848152602001838152602001828152506004906003620001699291906200044b565b50606060405190810160405280848152602001838152602001828152506007906003620001989291906200044b565b5060606040519081016040528060148501815260200183815260200182815250600d906003620001ca9291906200044b565b50604060405190810160405280600b81526020017f756e636f6e6669726d6564000000000000000000000000000000000000000000815250601260006005811015156200021357fe5b0160005b5090805190602001906200022d929190620003c4565b50604060405190810160405280600c81526020017f63616e42655265766f6b65640000000000000000000000000000000000000000815250601260016005811015156200027657fe5b0160005b50908051906020019062000290929190620003c4565b50604060405190810160405280600981526020017f636f6e6669726d6564000000000000000000000000000000000000000000000081525060126002600581101515620002d957fe5b0160005b509080519060200190620002f3929190620003c4565b50604060405190810160405280600381526020017f656e640000000000000000000000000000000000000000000000000000000000815250601260036005811015156200033c57fe5b0160005b50908051906020019062000356929190620003c4565b50604060405190810160405280600a81526020017f5265766f636174696f6e00000000000000000000000000000000000000000000815250601260046005811015156200039f57fe5b0160005b509080519060200190620003b9929190620003c4565b505b505050620004b8565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200040757805160ff191683800117855562000438565b8280016001018555821562000438579182015b82811115620004375782518255916020019190600101906200041a565b5b50905062000447919062000490565b5090565b82600381019282156200047d579160200282015b828111156200047c5782518255916020019190600101906200045f565b5b5090506200048c919062000490565b5090565b620004b591905b80821115620004b157600081600090555060010162000497565b5090565b90565b610fdc80620004c86000396000f300606060405236156100ce576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680630d8e6e2c146100d057806323cd7613146101695780633944615c146101c55780634e69d5601461021757806354fd4d50146102b057806383197ef0146103495780638ed301c11461035b578063951093f91461038d5780639b819d381461039f578063a275ee1b146103fb578063b16270fc14610457578063b6549f75146104a9578063e2863646146104bb578063e5fad55f14610517575bfe5b34156100d857fe5b6100e0610549565b604051808060200182810382528381815181526020019150805190602001908083836000831461012f575b80518252602083111561012f5760208201915060208101905060208303925061010b565b505050905090810190601f16801561015b5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561017157fe5b6101796105f2565b60405180826003602002808383600083146101b3575b8051825260208311156101b35760208201915060208101905060208303925061018f565b50505090500191505060405180910390f35b34156101cd57fe5b6101d561063e565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b341561021f57fe5b610227610669565b6040518080602001828103825283818151815260200191508051906020019080838360008314610276575b80518252602083111561027657602082019150602081019050602083039250610252565b505050905090810190601f1680156102a25780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156102b857fe5b6102c0610726565b604051808060200182810382528381815181526020019150805190602001908083836000831461030f575b80518252602083111561030f576020820191506020810190506020830392506102eb565b505050905090810190601f16801561033b5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561035157fe5b6103596107cf565b005b341561036357fe5b61038b6004808035906020019091908035906020019091908035906020019091905050610863565b005b341561039557fe5b61039d6109f8565b005b34156103a757fe5b6103af610a03565b60405180826003602002808383600083146103e9575b8051825260208311156103e9576020820191506020810190506020830392506103c5565b50505090500191505060405180910390f35b341561040357fe5b61040b610a4f565b6040518082600360200280838360008314610445575b80518252602083111561044557602082019150602081019050602083039250610421565b50505090500191505060405180910390f35b341561045f57fe5b610467610a9b565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34156104b157fe5b6104b9610ac6565b005b34156104c357fe5b6104cb610c2b565b6040518082600360200280838360008314610505575b805182526020831115610505576020820191506020810190506020830392506104e1565b50505090500191505060405180910390f35b341561051f57fe5b6105476004808035906020019091908035906020019091908035906020019091905050610c77565b005b610551610f0f565b60108054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156105e75780601f106105bc576101008083540402835291602001916105e7565b820191906000526020600020905b8154815290600101906020018083116105ca57829003601f168201915b505050505090505b90565b6105fa610f23565b600d600380602002604051908101604052809291908260038015610633576020028201915b81548152602001906001019080831161061f575b505050505090505b90565b6000600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690505b90565b610671610f0f565b601260115460058110151561068257fe5b0160005b508054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561071b5780601f106106f05761010080835404028352916020019161071b565b820191906000526020600020905b8154815290600101906020018083116106fe57829003601f168201915b505050505090505b90565b61072e610f0f565b60108054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107c45780601f10610799576101008083540402835291602001916107c4565b820191906000526020600020905b8154815290600101906020018083116107a757829003601f168201915b505050505090505b90565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141561086057600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16ff5b5b565b6000601154141515610918577fb1441657020533a47074b131a4015099aba9f3759fd167554f83e58e6c32354b3342604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200180602001838152602001828103825260168152602001807f6e6f7420796574206265656e20636f6e6669726d656400000000000000000000815250602001935050505060405180910390a16109f2565b600160118190555060606040519081016040528084815260200183815260200182815250600a90600361094c929190610f4b565b507fb1441657020533a47074b131a4015099aba9f3759fd167554f83e58e6c32354b3342604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001806020018381526020018281038252600f8152602001807f636f6e6669726d20737563636573730000000000000000000000000000000000815250602001935050505060405180910390a15b5b505050565b60036011819055505b565b610a0b610f23565b6007600380602002604051908101604052809291908260038015610a44576020028201915b815481526020019060010190808311610a30575b505050505090505b90565b610a57610f23565b6004600380602002604051908101604052809291908260038015610a90576020028201915b815481526020019060010190808311610a7c575b505050505090505b90565b6000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690505b90565b6001601154141515610b7b577f1a9169fb4279bed88eb7ecb94af54097a367328b7d11a0c29912475f117bdb3f3342604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200180602001838152602001828103825260128152602001807f43616e206e6f74206265207265766f6b65640000000000000000000000000000815250602001935050505060405180910390a1610c28565b60046011819055507f1a9169fb4279bed88eb7ecb94af54097a367328b7d11a0c29912475f117bdb3f3342604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200180602001838152602001828103825260138152602001807f7265766f6b652074686520636f6e747261637400000000000000000000000000815250602001935050505060405180910390a15b5b565b610c33610f23565b600a600380602002604051908101604052809291908260038015610c6c576020028201915b815481526020019060010190808311610c58575b505050505090505b90565b606060405190810160405280848152602001838152602001828152506007906003610ca3929190610f4b565b5060016011541415610d7957600a6000600381101515610cbf57fe5b0160005b5054831180610d065750600a6000600381101515610cdd57fe5b0160005b505483148015610d055750600a6001600381101515610cfc57fe5b0160005b505482115b5b80610d665750600a6000600381101515610d1c57fe5b0160005b505483148015610d445750600a6001600381101515610d3b57fe5b0160005b505482145b8015610d655750600a6002600381101515610d5b57fe5b0160005b50548110155b5b15610d745760026011819055505b610f09565b60026011541415610f0857600d6000600381101515610d9457fe5b0160005b5054831180610ddb5750600d6000600381101515610db257fe5b0160005b505483148015610dda5750600d6001600381101515610dd157fe5b0160005b505482115b5b80610e3b5750600d6000600381101515610df157fe5b0160005b505483148015610e195750600d6001600381101515610e1057fe5b0160005b505482145b8015610e3a5750600d6002600381101515610e3057fe5b0160005b50548110155b5b15610f0757601754600d6000600381101515610e5357fe5b0160005b82825401925050819055507fd0b235785168022a3906f35111d580e40c268c8ef520502cbb3282a23afd59ac3342604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001806020018381526020018281038252600b8152602001807f70617920616e6e75697479000000000000000000000000000000000000000000815250602001935050505060405180910390a15b5b5b5b505050565b602060405190810160405280600081525090565b6060604051908101604052806003905b6000815260200190600190039081610f335790505090565b8260038101928215610f7a579160200282015b82811115610f79578251825591602001919060010190610f5e565b5b509050610f879190610f8b565b5090565b610fad91905b80821115610fa9576000816000905550600101610f91565b5090565b905600a165627a7a723058201a0b67a8b263473486d974089ba6067b9cf8003049d6c157ed4d270907cc3b940029',
                gas: '4700000'
            }, function (e, contract) {
                console.log(e, contract);
                if (typeof contract.address !== 'undefined') {
                    console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                    //將contract加入mySQL

                    connection.connect();
                    console.log('INSERT INTO smart.contract (ID, address) VALUES (\''+ ID +'\', \'' + contract.address + '\');');

                    connection.query('INSERT INTO smart.contract (ID, address) VALUES (\''+ ID +'\', \'' + contract.address + '\');', function (error) {
                        if (error) {
                            console.log('寫入資料失敗！');
                            throw error;
                        }
                    });
                    
                    connection.end();
                    
                }
            })
    }
}

module.exports = Contract