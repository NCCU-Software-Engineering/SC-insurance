var web3 = require('./web3.js');
var connection = require('./mysql.js');

var annuityContract = web3.eth.contract([{
    "constant": true,
    "inputs": [],
    "name": "getVersion",
    "outputs": [{
        "name": "",
        "type": "string"
    }],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "getPayTime",
    "outputs": [{
        "name": "",
        "type": "uint256[3]"
    }],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "getCompanyAddress",
    "outputs": [{
        "name": "",
        "type": "address"
    }],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "getStatus",
    "outputs": [{
        "name": "",
        "type": "string"
    }],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "version",
    "outputs": [{
        "name": "",
        "type": "string"
    }],
    "payable": false,
    "type": "function"
}, {
    "constant": false,
    "inputs": [],
    "name": "destroy",
    "outputs": [],
    "payable": false,
    "type": "function"
}, {
    "constant": false,
    "inputs": [],
    "name": "endAnnuity",
    "outputs": [],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "getNowTime",
    "outputs": [{
        "name": "",
        "type": "uint256[3]"
    }],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "getDeployTime",
    "outputs": [{
        "name": "",
        "type": "uint256[3]"
    }],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "getInsurerAddress",
    "outputs": [{
        "name": "",
        "type": "address"
    }],
    "payable": false,
    "type": "function"
}, {
    "constant": false,
    "inputs": [],
    "name": "revoke",
    "outputs": [],
    "payable": false,
    "type": "function"
}, {
    "constant": false,
    "inputs": [{
        "name": "year",
        "type": "uint256"
    }, {
        "name": "month",
        "type": "uint256"
    }, {
        "name": "day",
        "type": "uint256"
    }],
    "name": "confirm",
    "outputs": [],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "getRevocationPeriod",
    "outputs": [{
        "name": "",
        "type": "uint256[3]"
    }],
    "payable": false,
    "type": "function"
}, {
    "constant": false,
    "inputs": [{
        "name": "year",
        "type": "uint256"
    }, {
        "name": "month",
        "type": "uint256"
    }, {
        "name": "day",
        "type": "uint256"
    }],
    "name": "time",
    "outputs": [],
    "payable": false,
    "type": "function"
}, {
    "inputs": [{
        "name": "y",
        "type": "uint256"
    }, {
        "name": "m",
        "type": "uint256"
    }, {
        "name": "d",
        "type": "uint256"
    }],
    "payable": false,
    "type": "constructor"
}, {
    "anonymous": false,
    "inputs": [{
        "indexed": false,
        "name": "from",
        "type": "address"
    }, {
        "indexed": false,
        "name": "inf",
        "type": "string"
    }, {
        "indexed": false,
        "name": "timestamp",
        "type": "uint256"
    }],
    "name": "confirmEvent",
    "type": "event"
}, {
    "anonymous": false,
    "inputs": [{
        "indexed": false,
        "name": "from",
        "type": "address"
    }, {
        "indexed": false,
        "name": "inf",
        "type": "string"
    }, {
        "indexed": false,
        "name": "timestamp",
        "type": "uint256"
    }],
    "name": "revokeEvent",
    "type": "event"
}, {
    "anonymous": false,
    "inputs": [{
        "indexed": false,
        "name": "from",
        "type": "address"
    }, {
        "indexed": false,
        "name": "inf",
        "type": "string"
    }, {
        "indexed": false,
        "name": "timestamp",
        "type": "uint256"
    }],
    "name": "payEvent",
    "type": "event"
}]);
class Contract {
    constructor() {

    }
    deploy(ID) {
        this.annuity = annuityContract.new(
            new Date().getFullYear(), new Date().getMonth() + 1, new Date().getDate(), {
                from: web3.eth.accounts[0],
                data: '6060604052604060405190810160405280600581526020017f312e302e3400000000000000000000000000000000000000000000000000000081525060119080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200008857805160ff1916838001178555620000b9565b82800160010185558215620000b9579182015b82811115620000b85782518255916020019190600101906200009b565b5b509050620000e191905b80821115620000dd576000816000905550600101620000c3565b5090565b505034620000005760405160608062001814833981016040528080519060200190919080519060200190919080519060200190919050505b33600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555073e2320c12c71fb4a91d756d21507b33ee05f2f4c7600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506103e86004819055506001601781905550600060038190555060606040519081016040528084815260200183815260200182815250600590600382600381019282156200021b579160200282015b828111156200021a578251825591602001919060010190620001fd565b5b5090506200024391905b808211156200023f57600081600090555060010162000225565b5090565b5050606060405190810160405280848152602001838152602001828152506008906003826003810192821562000298579160200282015b82811115620002975782518255916020019190600101906200027a565b5b509050620002c091905b80821115620002bc576000816000905550600101620002a2565b5090565b505060606040519081016040528060148501815260200183815260200182815250600e906003826003810192821562000318579160200282015b8281111562000317578251825591602001919060010190620002fa565b5b5090506200034091905b808211156200033c57600081600090555060010162000322565b5090565b5050604060405190810160405280600b81526020017f756e636f6e6669726d656400000000000000000000000000000000000000000081525060126000600581101562000000570160005b509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10620003d757805160ff191683800117855562000408565b8280016001018555821562000408579182015b8281111562000407578251825591602001919060010190620003ea565b5b5090506200043091905b808211156200042c57600081600090555060010162000412565b5090565b5050604060405190810160405280600c81526020017f63616e42655265766f6b6564000000000000000000000000000000000000000081525060126001600581101562000000570160005b509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10620004c757805160ff1916838001178555620004f8565b82800160010185558215620004f8579182015b82811115620004f7578251825591602001919060010190620004da565b5b5090506200052091905b808211156200051c57600081600090555060010162000502565b5090565b5050604060405190810160405280600881526020017f636f6e6669726d6400000000000000000000000000000000000000000000000081525060126002600581101562000000570160005b509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10620005b757805160ff1916838001178555620005e8565b82800160010185558215620005e8579182015b82811115620005e7578251825591602001919060010190620005ca565b5b5090506200061091905b808211156200060c576000816000905550600101620005f2565b5090565b5050604060405190810160405280600381526020017f656e64000000000000000000000000000000000000000000000000000000000081525060126003600581101562000000570160005b509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10620006a757805160ff1916838001178555620006d8565b82800160010185558215620006d8579182015b82811115620006d7578251825591602001919060010190620006ba565b5b5090506200070091905b80821115620006fc576000816000905550600101620006e2565b5090565b5050604060405190810160405280600a81526020017f5265766f636174696f6e0000000000000000000000000000000000000000000081525060126004600581101562000000570160005b509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200079757805160ff1916838001178555620007c8565b82800160010185558215620007c8579182015b82811115620007c7578251825591602001919060010190620007aa565b5b509050620007f091905b80821115620007ec576000816000905550600101620007d2565b5090565b50505b5050505b61100d80620008076000396000f300606060405236156100ce576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680630d8e6e2c146100d357806323cd7613146101695780633944615c146101c25780634e69d5601461021157806354fd4d50146102a757806383197ef01461033d578063951093f91461034c5780639b819d381461035b578063a275ee1b146103b4578063b16270fc1461040d578063b6549f751461045c578063b9f394d91461046b578063e28636461461049a578063e5fad55f146104f3575b610000565b34610000576100e0610522565b604051808060200182810382528381815181526020019150805190602001908083836000831461012f575b80518252602083111561012f5760208201915060208101905060208303925061010b565b505050905090810190601f16801561015b5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34610000576101766105d4565b60405180826003602002808383600083146101b0575b8051825260208311156101b05760208201915060208101905060208303925061018c565b50505090500191505060405180910390f35b34610000576101cf61063d565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b346100005761021e610668565b604051808060200182810382528381815181526020019150805190602001908083836000831461026d575b80518252602083111561026d57602082019150602081019050602083039250610249565b505050905090810190601f1680156102995780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34610000576102b461072b565b6040518080602001828103825283818151815260200191508051906020019080838360008314610303575b805182526020831115610303576020820191506020810190506020830392506102df565b505050905090810190601f16801561032f5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761034a6107dd565b005b3461000057610359610871565b005b346100005761036861087c565b60405180826003602002808383600083146103a2575b8051825260208311156103a25760208201915060208101905060208303925061037e565b50505090500191505060405180910390f35b34610000576103c16108e5565b60405180826003602002808383600083146103fb575b8051825260208311156103fb576020820191506020810190506020830392506103d7565b50505090500191505060405180910390f35b346100005761041a61094e565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b3461000057610469610979565b005b34610000576104986004808035906020019091908035906020019091908035906020019091905050610ade565b005b34610000576104a7610cbd565b60405180826003602002808383600083146104e1575b8051825260208311156104e1576020820191506020810190506020830392506104bd565b50505090500191505060405180910390f35b34610000576105206004808035906020019091908035906020019091908035906020019091905050610d26565b005b602060405190810160405280600081525060118054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156105c95780601f1061059e576101008083540402835291602001916105c9565b820191906000526020600020905b8154815290600101906020018083116105ac57829003601f168201915b505050505090505b90565b6060604051908101604052806003905b60008152602001906001900390816105e457905050600e600380602002604051908101604052809291908260038015610632576020028201915b81548152602001906001019080831161061e575b505050505090505b90565b6000600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690505b90565b602060405190810160405280600081525060126003546005811015610000570160005b508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107205780601f106106f557610100808354040283529160200191610720565b820191906000526020600020905b81548152906001019060200180831161070357829003601f168201915b505050505090505b90565b602060405190810160405280600081525060118054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107d25780601f106107a7576101008083540402835291602001916107d2565b820191906000526020600020905b8154815290600101906020018083116107b557829003601f168201915b505050505090505b90565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141561086e57600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16ff5b5b565b60036003819055505b565b6060604051908101604052806003905b600081526020019060019003908161088c5790505060086003806020026040519081016040528092919082600380156108da576020028201915b8154815260200190600101908083116108c6575b505050505090505b90565b6060604051908101604052806003905b60008152602001906001900390816108f5579050506005600380602002604051908101604052809291908260038015610943576020028201915b81548152602001906001019080831161092f575b505050505090505b90565b6000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690505b90565b6001600354141515610a2e577f1a9169fb4279bed88eb7ecb94af54097a367328b7d11a0c29912475f117bdb3f3342604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200180602001838152602001828103825260128152602001807f43616e206e6f74206265207265766f6b65640000000000000000000000000000815250602001935050505060405180910390a1610adb565b60046003819055507f1a9169fb4279bed88eb7ecb94af54097a367328b7d11a0c29912475f117bdb3f3342604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200180602001838152602001828103825260138152602001807f7265766f6b652074686520636f6e747261637400000000000000000000000000815250602001935050505060405180910390a15b5b565b6000600354141515610b93577f605670d1c219f30ccb3bb9e8578350f540fb5b6d8e01d55836f2d89a39e41e0b3342604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200180602001838152602001828103825260168152602001807f6e6f7420796574206265656e20636f6e6669726d656400000000000000000000815250602001935050505060405180910390a1610cb7565b600160038190555060606040519081016040528084815260200183815260200182815250600b9060038260038101928215610beb579160200282015b82811115610bea578251825591602001919060010190610bcf565b5b509050610c1091905b80821115610c0c576000816000905550600101610bf4565b5090565b50507f605670d1c219f30ccb3bb9e8578350f540fb5b6d8e01d55836f2d89a39e41e0b3342604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001806020018381526020018281038252600f8152602001807f636f6e6669726d20737563636573730000000000000000000000000000000000815250602001935050505060405180910390a15b5b505050565b6060604051908101604052806003905b6000815260200190600190039081610ccd57905050600b600380602002604051908101604052809291908260038015610d1b576020028201915b815481526020019060010190808311610d07575b505050505090505b90565b6060604051908101604052808481526020018381526020018281525060089060038260038101928215610d76579160200282015b82811115610d75578251825591602001919060010190610d5a565b5b509050610d9b91905b80821115610d97576000816000905550600101610d7f565b5090565b505060016003541415610e6057600b60006003811015610000570160005b5054831180610df65750600b60006003811015610000570160005b505483148015610df55750600b60016003811015610000570160005b505482115b5b80610e4d5750600b60006003811015610000570160005b505483148015610e2e5750600b60016003811015610000570160005b505482145b8015610e4c5750600b60026003811015610000570160005b50548110155b5b15610e5b5760026003819055505b610fdb565b60026003541415610fda57600e60006003811015610000570160005b5054831180610eb95750600e60006003811015610000570160005b505483148015610eb85750600e60016003811015610000570160005b505482115b5b80610f105750600e60006003811015610000570160005b505483148015610ef15750600e60016003811015610000570160005b505482145b8015610f0f5750600e60026003811015610000570160005b50548110155b5b15610fd957601754600e60006003811015610000570160005b82825401925050819055507fd0b235785168022a3906f35111d580e40c268c8ef520502cbb3282a23afd59ac3342604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001806020018381526020018281038252600b8152602001807f70617920616e6e75697479000000000000000000000000000000000000000000815250602001935050505060405180910390a15b5b5b5b5050505600a165627a7a723058200af22eafc616755c82d357cbf827922ae523e06ef9b698d475f24299ab282af60029',
                gas: '4700000'
            },
            function (e, contract) {
                console.log(e, contract);
                if (typeof contract.address !== 'undefined') {
                    console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                    //將contract加入mySQL

                    console.log('INSERT INTO smart.contract (ID, address) VALUES (\'' + ID + '\', \'' + contract.address + '\');');

                    connection.query('INSERT INTO smart.contract (ID, address) VALUES (\'' + ID + '\', \'' + contract.address + '\');', function (error) {
                        if (error) {
                            console.log('寫入資料失敗！');
                            throw error;
                        }
                    });
                }
            })
    }

}

module.exports = Contract